{% extends 'tracker/base.html' %}

{% block content %}
<style>
  table th, table td {
    vertical-align: middle;
    white-space: normal;
  }
  td {
    min-width: 120px;
  }
</style>

<div class="d-flex justify-content-between align-items-center mb-3">
    <h2>Projects</h2>

    <div>
        <a href="{% url 'tracker:add' %}" class="btn btn-success btn-sm">+ Add Project</a>
        <a href="{% url 'tracker:export_csv' %}" class="btn btn-outline-primary btn-sm">CSV</a>
        <a href="{% url 'tracker:export_excel' %}" class="btn btn-outline-success btn-sm">Excel</a>
        <a href="{% url 'tracker:export_pdf' %}" class="btn btn-outline-danger btn-sm">PDF</a>
    </div>
</div>

<form method="get" class="row g-2 align-items-end mb-3">
    <div class="col-md-2">
        <label class="form-label">Aircraft</label>
        <select name="aircraft" class="form-select">
            <option value="All">All</option>
            {% for a in aircraft_list %}
            <option value="{{ a }}" {% if selected_aircraft == a %}selected{% endif %}>{{ a }}</option>
            {% endfor %}
        </select>
    </div>

    <div class="col-md-2">
        <label class="form-label">Status</label>
        <select name="status" class="form-select">
            <option value="All">All</option>
            {% for s in status_choices %}
            <option value="{{ s }}" {% if selected_status == s %}selected{% endif %}>{{ s }}</option>
            {% endfor %}
        </select>
    </div>

    <div class="col-md-4">
        <label class="form-label">Search</label>
        <input type="search" name="q" value="{{ q }}" class="form-control" placeholder="Search name or brief">
    </div>

    <div class="col-md-4">
        <button class="btn btn-primary">Apply</button>
        <a href="{% url 'tracker:list' %}" class="btn btn-outline-secondary">Clear</a>
    </div>
</form>

<div class="table-responsive">
<table class="table table-bordered table-hover align-middle">
    <thead class="table-primary text-center">
        <tr>
            <th>Sl.No</th>
            <th>Project Name</th>
            <th>Brief</th>
            <th>Status</th>
            <th>Start</th>
            <th>Aircraft</th>
            <th>No. Meetings</th>
            <th>IOM/TM</th>
            <th>No. Sorties</th>
            <th>Trials</th>
            <th>End</th>
            <th style="min-width:220px;">Misc Reason</th>
            <th style="min-width:220px;">Marked Reason</th>
            <th style="min-width:160px;">Marked By</th>
            <th style="min-width:140px;">Document</th>
            <th style="min-width:120px;">Actions</th>
        </tr>
    </thead>
    <tbody>
        {% for p in projects %}
        <tr>
            <td class="text-center">{{ forloop.counter }}</td>
            <td>{{ p.project_name }}</td>
            <td style="max-width:300px;">{{ p.brief|linebreaksbr }}</td>
            <td class="text-center">{{ p.status }}</td>
            <td class="text-center">{{ p.start_date }}</td>
            <td style="max-width:220px;">{{ p.miscellaneous_reason|default:"—" }}</td>
            <td style="max-width:220px;">{{ p.marked_reason|default:"—" }}</td>
            <td>{{ p.marked_by|default:"—" }}</td>
            <td class="text-center">
              {% if p.attachment %}
                <a href="{{ p.attachment.url }}" target="_blank">View</a>
              {% else %}
                —
              {% endif %}
            </td>

            <td>
                <select class="form-select aircraft-select" data-id="{{ p.id }}">
                    <option value="">--</option>
                    {% for a in aircraft_list %}
                    <option value="{{ a }}" {% if p.aircraft == a %}selected{% endif %}>{{ a }}</option>
                    {% endfor %}
                </select>
            </td>

            <td class="text-center no_meetings">{{ p.no_meetings }}</td>
            <td class="text-center iom_tm">{{ p.iom_tm }}</td>
            <td class="text-center no_sorties">{{ p.no_sorties }}</td>
            <td class="text-center">{{ p.trials }}</td>
            <td class="text-center">{{ p.end_date }}</td>

            <td class="text-center">
                {% if user.is_staff %}
                   <a href="{% url 'tracker:edit' p.id %}" class="btn btn-sm btn-outline-primary">Edit</a>
                   <a href="{% url 'tracker:delete' p.id %}" class="btn btn-sm btn-outline-danger">Delete</a>
                {% else %}
                   <span class="text-muted">View only</span>
                {% endif %}
            </td>
        </tr>
        {% empty %}
        <tr>
            <td colspan="12" class="text-center text-muted">
                No projects yet.
                <a href="{% url 'tracker:add' %}">Add one</a>.
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>
</div>

<nav class="mt-3">
<ul class="pagination justify-content-center">
    {% if projects.has_previous %}
    <li class="page-item">
        <a class="page-link" href="?page={{ projects.previous_page_number }}">Previous</a>
    </li>
    {% endif %}

    <li class="page-item disabled">
        <span class="page-link">
            Page {{ projects.number }} of {{ projects.paginator.num_pages }}
        </span>
    </li>

    {% if projects.has_next %}
    <li class="page-item">
        <a class="page-link" href="?page={{ projects.next_page_number }}">Next</a>
    </li>
    {% endif %}
</ul>
</nav>

<div class="row mt-4">
    <div class="col-md-6">
        <canvas id="statusChart"></canvas>
    </div>
    <div class="col-md-6">
        <canvas id="aircraftChart"></canvas>
    </div>
</div>
{% endblock %}
